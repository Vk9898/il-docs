import { GoogleGenerativeAI } from '@google/generative-ai';
import PDFDocument from 'pdfkit';
import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Gemini API configuration
const GEMINI_API_KEY = 'AIzaSyDyLUz5XFZW_9FN2a-M2BvPUJZfkoiUbWw';
const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);

// Languages to translate to
const LANGUAGES = [
  { code: 'ar', name: 'Arabic' },
  { code: 'bn', name: 'Bengali' },
  { code: 'bg', name: 'Bulgarian' },
  { code: 'zh-CN', name: 'Chinese (Simplified)' },
  { code: 'zh-TW', name: 'Chinese (Traditional)' },
  { code: 'hr', name: 'Croatian' },
  { code: 'cs', name: 'Czech' },
  { code: 'da', name: 'Danish' },
  { code: 'nl', name: 'Dutch' },
  { code: 'en', name: 'English' },
  { code: 'et', name: 'Estonian' },
  { code: 'fa', name: 'Farsi' },
  { code: 'fi', name: 'Finnish' },
  { code: 'fr', name: 'French' },
  { code: 'de', name: 'German' },
  { code: 'el', name: 'Greek' },
  { code: 'gu', name: 'Gujarati' },
  { code: 'he', name: 'Hebrew' },
  { code: 'hi', name: 'Hindi' },
  { code: 'hu', name: 'Hungarian' },
  { code: 'id', name: 'Indonesian' },
  { code: 'it', name: 'Italian' },
  { code: 'ja', name: 'Japanese' },
  { code: 'kn', name: 'Kannada' },
  { code: 'ko', name: 'Korean' },
  { code: 'lv', name: 'Latvian' },
  { code: 'lt', name: 'Lithuanian' },
  { code: 'ml', name: 'Malayalam' },
  { code: 'mr', name: 'Marathi' },
  { code: 'no', name: 'Norwegian' },
  { code: 'pl', name: 'Polish' },
  { code: 'pt', name: 'Portuguese' },
  { code: 'ro', name: 'Romanian' },
  { code: 'ru', name: 'Russian' },
  { code: 'sr', name: 'Serbian' },
  { code: 'sk', name: 'Slovak' },
  { code: 'sl', name: 'Slovenian' },
  { code: 'es', name: 'Spanish' },
  { code: 'sw', name: 'Swahili' },
  { code: 'sv', name: 'Swedish' },
  { code: 'ta', name: 'Tamil' },
  { code: 'te', name: 'Telugu' },
  { code: 'th', name: 'Thai' },
  { code: 'tr', name: 'Turkish' },
  { code: 'uk', name: 'Ukrainian' },
  { code: 'ur', name: 'Urdu' },
  { code: 'vi', name: 'Vietnamese' }
];

// Disclaimer text
const getDisclaimer = (language) => {
  return `IMPORTANT DISCLAIMER:

This document has been translated from English to ${language} using InstaLaw's automated translation service powered by Google Gemini 2.0 Flash. This translation is provided for convenience only and should not be considered as legal advice or as establishing any attorney-client relationship or privilege.

AI Translation Notice:
• This translation was generated using artificial intelligence (Gemini 2.0 Flash)
• AI systems are prone to hallucinations and may produce inaccuracies
• The information is presented "as-is" without any warranties of accuracy or completeness
• For legal matters, always consult with a qualified attorney and refer to the original English document
• This translation does not constitute legal advice, representation, or create any attorney-client privilege

The original document should be considered the authoritative version. Any discrepancies between this translation and the original English document should be resolved in favor of the original.

Translation performed on: ${new Date().toISOString()}
Prompt used: "Please translate the following legal document from English to ${language}, do not make omissions, do not fabricate falsehoods. Just translate in its entirety the provided document as best you can given the context."

--------------------

`;
};

// Create PDF with translated content
async function createPDF(translatedContent, language, outputPath) {
  return new Promise((resolve, reject) => {
    try {
      const doc = new PDFDocument({
        size: 'A4',
        margins: {
          top: 72,
          bottom: 72,
          left: 72,
          right: 72
        }
      });

      const stream = fs.createWriteStream(outputPath);
      doc.pipe(stream);

      // Add InstaLaw branding in blue at top left
      doc.fontSize(14)
         .fillColor('#0066CC')
         .text('INSTALAW', 72, 50, { align: 'left' })
         .fontSize(10)
         .fillColor('#666666')
         .text('Document Generated by InstaLaw Translation Service', 72, 70);

      // Add disclaimer
      doc.moveDown(2);
      doc.fontSize(9)
         .fillColor('#FF0000')
         .text(getDisclaimer(language.name), {
           align: 'justify',
           lineGap: 2
         });

      // Add horizontal line
      doc.moveDown();
      doc.strokeColor('#CCCCCC')
         .lineWidth(1)
         .moveTo(72, doc.y)
         .lineTo(doc.page.width - 72, doc.y)
         .stroke();

      doc.moveDown(2);

      // Add translated content
      doc.fontSize(11)
         .fillColor('#000000')
         .text(translatedContent, {
           align: 'justify',
           lineGap: 3
         });

      doc.end();

      stream.on('finish', () => {
        console.log(`✓ PDF created for ${language.name}: ${outputPath}`);
        resolve();
      });

      stream.on('error', reject);
    } catch (error) {
      reject(error);
    }
  });
}

// Translate document using Gemini
async function translateDocument(originalText, language) {
  try {
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });
    
    const prompt = `Please translate the following legal document from English to ${language.name}, do not make omissions, do not fabricate falsehoods. Just translate in its entirety the provided document as best you can given the context.

IMPORTANT: Maintain all formatting, paragraph breaks, and structure of the original document. Translate legal terms accurately while preserving their legal meaning.

Document to translate:

${originalText}`;

    console.log(`Translating to ${language.name}...`);
    const result = await model.generateContent(prompt);
    const translation = result.response.text();
    
    return translation;
  } catch (error) {
    console.error(`Error translating to ${language.name}:`, error);
    throw error;
  }
}

// Rate limiting helper
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// Main translation function
async function translateAllDocuments() {
  try {
    // Read the original document
    const originalPath = path.join(__dirname, 'original-document', 'Kroll_complaint.md');
    const originalText = await fs.readFile(originalPath, 'utf-8');
    
    console.log('Starting translation process for 40 languages...\n');
    
    // Process languages in batches to avoid rate limiting
    const batchSize = 5;
    for (let i = 0; i < LANGUAGES.length; i += batchSize) {
      const batch = LANGUAGES.slice(i, i + batchSize);
      
      await Promise.all(batch.map(async (language) => {
        try {
          // Translate the document
          const translation = await translateDocument(originalText, language);
          
          // Save raw Gemini response
          const rawOutputPath = path.join(
            __dirname,
            'translations',
            `kroll_complaint_${language.code}_raw.md`
          );
          await fs.writeFile(rawOutputPath, translation, 'utf-8');
          console.log(`✓ Raw markdown saved for ${language.name}`);
          
          // Create PDF with disclaimer and branding
          const pdfOutputPath = path.join(
            __dirname,
            'translations',
            `kroll_complaint_${language.code}.pdf`
          );
          await createPDF(translation, language, pdfOutputPath);
          
        } catch (error) {
          console.error(`Failed to process ${language.name}:`, error.message);
        }
      }));
      
      // Rate limiting between batches
      if (i + batchSize < LANGUAGES.length) {
        console.log(`\nWaiting before next batch...`);
        await sleep(5000); // 5 second delay between batches
      }
    }
    
    console.log('\n✅ Translation process complete!');
    console.log(`Files saved in: ${path.join(__dirname, 'translations')}`);
    
  } catch (error) {
    console.error('Fatal error:', error);
    process.exit(1);
  }
}

// Run the translation
translateAllDocuments();